// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Loly's Kunafa House â€” Google Apps Script
// Paste this entire file into script.google.com, then:
//   Deploy â†’ New Deployment â†’ Web App
//   Execute as: Me | Who has access: Anyone
//   Copy the new URL and update SCRIPT constant in index.html
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const NOTIFY_EMAILS = 'hamdielshimi@gmail.com, Mohamedqw4@gmail.com';
const SHEET_NAME    = 'Orders';  // rename to match your sheet tab

function doPost(e) {
  try {
    const data   = JSON.parse(e.postData.contents);
    const sheet  = getOrCreateSheet();
    const now    = new Date();
    const rowNum = sheet.getLastRow() + 1;

    // Auto-generate order number if not provided
    const orderNo = data.orderNumber || ('ORD-' + now.getTime().toString().slice(-6));

    // Write row: timestamp, order#, name, phone, address, order, message
    sheet.appendRow([
      Utilities.formatDate(now, 'Africa/Cairo', 'yyyy-MM-dd HH:mm:ss'),
      orderNo,
      data.name    || '',
      data.phone   || '',
      data.address || '',
      data.order   || '',
      data.message || ''
    ]);

    // Send email notifications
    sendEmailNotification(data, orderNo, now);

    return ContentService
      .createTextOutput(JSON.stringify({ success: true, orderNumber: orderNo }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService
    .createTextOutput('Loly\'s Kunafa House â€” Order API is running.')
    .setMimeType(ContentService.MimeType.TEXT);
}

function getOrCreateSheet() {
  const ss    = SpreadsheetApp.getActiveSpreadsheet();
  let sheet   = ss.getSheetByName(SHEET_NAME);

  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    // Add header row
    sheet.appendRow(['Timestamp', 'Order #', 'Name', 'Phone', 'Address', 'Order Details', 'Notes']);
    sheet.getRange(1, 1, 1, 7).setFontWeight('bold').setBackground('#D4AF37');
  }

  return sheet;
}

function sendEmailNotification(data, orderNo, timestamp) {
  const dateStr = Utilities.formatDate(timestamp, 'Africa/Cairo', 'dd MMM yyyy  HH:mm');

  const subject = `ğŸ° New Order ${orderNo} â€” ${data.name || 'Unknown'}`;

  const body = `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ°  LOLY'S KUNAFA HOUSE â€” NEW ORDER
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹  Order Number : ${orderNo}
ğŸ•  Date & Time  : ${dateStr}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CUSTOMER DETAILS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‘¤  Name    : ${data.name    || 'â€”'}
ğŸ“  Phone   : ${data.phone   || 'â€”'}
ğŸ“  Address : ${data.address || 'â€”'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ORDER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${data.order || 'â€”'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
NOTES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${data.message || 'None'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Reply to customer on WhatsApp: ${data.phone || 'â€”'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`.trim();

  const htmlBody = `
<div style="font-family:Arial,sans-serif;max-width:580px;margin:0 auto;border:2px solid #D4AF37;border-radius:12px;overflow:hidden">
  <div style="background:#2C1810;padding:24px 28px;text-align:center">
    <h1 style="color:#D4AF37;font-size:22px;margin:0">ğŸ° Loly's Kunafa House</h1>
    <p style="color:rgba(255,255,255,.7);font-size:13px;margin:6px 0 0">New Order Received</p>
  </div>
  <div style="padding:28px">
    <table style="width:100%;border-collapse:collapse;font-size:14px">
      <tr><td style="padding:8px;background:#FDF8EE;font-weight:bold;width:38%;border-radius:6px">Order #</td><td style="padding:8px;color:#2C1810;font-weight:bold">${orderNo}</td></tr>
      <tr><td style="padding:8px;font-weight:bold">Date & Time</td><td style="padding:8px">${dateStr}</td></tr>
      <tr><td style="padding:8px;background:#FDF8EE;font-weight:bold;border-radius:6px">Name</td><td style="padding:8px;background:#FDF8EE">${data.name||'â€”'}</td></tr>
      <tr><td style="padding:8px;font-weight:bold">Phone</td><td style="padding:8px">${data.phone||'â€”'}</td></tr>
      <tr><td style="padding:8px;background:#FDF8EE;font-weight:bold;border-radius:6px">Address</td><td style="padding:8px;background:#FDF8EE">${data.address||'â€”'}</td></tr>
    </table>
    <div style="margin-top:20px;padding:16px;background:#FDF8EE;border-left:4px solid #D4AF37;border-radius:0 8px 8px 0">
      <strong style="color:#6B4423">Order Details:</strong><br>
      <span style="font-size:14px;line-height:1.8">${(data.order||'â€”').replace(/,\s*/g,'<br>')}</span>
    </div>
    ${data.message ? `<div style="margin-top:14px;padding:14px;background:#f5f5f5;border-radius:8px;font-size:13px;color:#555"><strong>Notes:</strong> ${data.message}</div>` : ''}
    <div style="margin-top:24px;text-align:center">
      <a href="https://wa.me/${(data.phone||'').replace(/[^0-9]/g,'')}" style="background:#25D366;color:#fff;padding:12px 28px;border-radius:50px;text-decoration:none;font-weight:bold;font-size:14px">ğŸ“² Reply on WhatsApp</a>
    </div>
  </div>
  <div style="background:#2C1810;padding:14px;text-align:center;font-size:12px;color:rgba(255,255,255,.5)">
    Loly's Kunafa House â€” Cairo, Egypt
  </div>
</div>
`;

  MailApp.sendEmail({
    to:       NOTIFY_EMAILS,
    subject:  subject,
    body:     body,
    htmlBody: htmlBody
  });
}
